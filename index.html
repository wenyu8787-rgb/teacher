<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å¸«æƒ…ç·’å½©è™¹å¡ - æ¯æ—¥æ¿€å‹µ</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Google å­—é«” Inter å’Œ Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <!-- è¼‰å…¥ html2canvas å‡½å¼åº«ï¼Œç”¨æ–¼æˆªåœ–ä¸‹è¼‰ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* è¨­å®šå…¨åŸŸå­—é«”ï¼Œå„ªå…ˆä½¿ç”¨ Noto Sans TC æ”¯æ´ä¸­æ–‡ */
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #f7f3f9; /* æŸ”å’Œæ·ºç´«è‰²èƒŒæ™¯ */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* å…§å®¹å€å¡Šçš„å…±åŒæœ€å¤§å¯¬åº¦ */
        .max-w-container {
            max-width: 42rem; /* ç´„ 672pxï¼Œç¢ºä¿çµæ§‹æ¸…æ™° */
            width: 100%;
        }

        /* å¡ç‰‡å°ˆå±¬æ¨£å¼ */
        .rainbow-card {
            min-height: 250px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1), 0 5px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.5s ease-in-out;
            cursor: pointer;
            border: 4px solid #fff; /* ç™½è‰²é‚Šæ¡† */
            background-image: linear-gradient(135deg, #FFB6C1 0%, #FFDAB9 100%); /* é è¨­æ¼¸å±¤ (ç¬¬ä¸€å¼µå¡é¡è‰²) */
            background-size: 200% 200%;
            animation: gradient-shift 10s ease infinite;
        }

        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* æŠ½å¡æŒ‰éˆ•æ¨£å¼ */
        .main-button {
            background-image: linear-gradient(45deg, #6B46C1, #9F7AEA); /* æŸ”å’Œç´«è‰²æ¼¸å±¤ */
            transition: all 0.3s ease;
        }
        .main-button:hover:not(:disabled) {
            box-shadow: 0 10px 20px rgba(159, 122, 234, 0.4);
            transform: translateY(-2px);
        }
        .main-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* åˆ—å°æŒ‰éˆ•æ¨£å¼ */
        .print-button {
            background-color: #4B5563; /* ç°è‰²èƒŒæ™¯ */
            transition: all 0.3s ease;
        }
        .print-button:hover {
            background-color: #374151; /* æ·±ç°è‰² */
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
            transform: translateY(-1px);
        }
        
        /* AI è§£è®€æŒ‰éˆ•æ¨£å¼ */
        .interpret-button {
            background-color: #FBBF24; /* ç¥ç€è‰² */
            color: #854D0E; /* æ·±æ£•è‰²æ–‡å­— */
            transition: all 0.3s ease;
        }
        .interpret-button:hover:not(:disabled) {
            background-color: #F59E0B;
            box-shadow: 0 5px 10px rgba(245, 158, 11, 0.4);
            transform: translateY(-1px);
        }
        .interpret-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* éš±è—å…§å®¹çš„å‹•ç•« */
        .hidden-content {
            opacity: 0;
            transform: translateY(10px);
        }
        .show-content {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }

        /* è‡ªè¨‚ä½³å¥å€å¡Šçš„éš±è—/é¡¯ç¤ºå‹•ç•« */
        .collapsible {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .collapsible.active {
            max-height: 500px; /* è¨­ç½®ä¸€å€‹è¶³å¤ å¤§çš„é«˜åº¦ */
        }
        
        /* é¡åƒå½©è™¹åœ–ç¤º */
        #mirroredRainbow {
            transform: scaleX(-1);
        }
    </style>
</head>
<body>
    <div class="max-w-container">
        <!-- åˆ—å°/ä¸‹è¼‰çš„æ•æ‰å€åŸŸï¼ŒåŒ…å«ä¸ŠåŠéƒ¨å…§å®¹ -->
        <div id="printableArea" class="bg-white rounded-3xl p-6 md:p-10 shadow-2xl">
            <header class="text-center mb-8">
                <!-- æ¨™é¡Œï¼šå³å´å½©è™¹åœ–ç¤ºå·²æ·»åŠ é¡åƒ CSS -->
                <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸŒˆ æ•™å¸«æƒ…ç·’å½©è™¹å¡ <span id="mirroredRainbow" class="inline-block">ğŸŒˆ</span></h1>
                <p id="dateDisplay" class="text-lg text-purple-500 font-medium">ä»Šå¤©æ˜¯...</p>
                <p class="text-sm text-gray-500 mt-1">çµ¦è‡ªå·±ä¸€é»æº«æŸ”ï¼Œå¾å¡ç‰‡ä¸­æ±²å–åŠ›é‡ã€‚</p>
            </header>

            <!-- è¨Šæ¯/éŒ¯èª¤æç¤ºå€ -->
            <div id="messageBox" class="text-center p-3 mb-6 hidden rounded-xl" role="alert"></div>

            <!-- å½©è™¹å¡ç‰‡å€ -->
            <div id="cardContainer" class="rainbow-card flex flex-col justify-center items-center text-center p-8 rounded-2xl text-white">
                <p id="cardTitle" class="text-2xl font-bold mb-4">ç³»çµ±æº–å‚™ä¸­...</p>
                <p id="cardContent" class="text-lg hidden-content">å¡ç‰‡å…§å®¹</p>
                <p id="cardFooter" class="text-sm mt-4 hidden-content">ğŸŒŸ æ„Ÿè¬ä½ çš„ä»˜å‡º ğŸŒŸ</p>
            </div>
            
            <!-- Gemini API è§£è®€çµæœå€å¡Š -->
            <div id="geminiInterpretationArea" class="mt-6 p-4 bg-purple-50 rounded-xl shadow-inner text-gray-700 hidden">
                <h3 class="text-lg font-semibold text-purple-700 mb-2">âœ¨ ä½ çš„ä»Šæ—¥æ‡‰ç”¨å»ºè­°ï¼š</h3>
                <p id="geminiInterpretationText"></p>
            </div>

        </div>
        <!-- çµæŸåˆ—å°æ•æ‰å€åŸŸ -->

        <!-- æŒ‰éˆ•å€å¡Š (ä½æ–¼æ•æ‰å€åŸŸä¸‹æ–¹) -->
        <div class="mt-8">
            <button id="drawButton" 
                    class="w-full py-3 px-6 rounded-xl text-white font-semibold text-lg shadow-lg main-button"
                    onclick="drawCard()" disabled>
                è¼‰å…¥ä¸­...
            </button>
            <div class="mt-4 flex flex-col md:flex-row justify-between gap-4">
                <button id="interpretButton" 
                        class="flex-1 py-3 px-6 rounded-xl font-semibold text-base shadow-lg interpret-button hidden"
                        onclick="getGeminiInterpretation()">
                    âœ¨ ç²å¾—ä»Šæ—¥æ‡‰ç”¨å»ºè­°
                </button>
                <button id="printButton" 
                        class="flex-1 py-3 px-6 rounded-xl text-white font-semibold text-base shadow-lg print-button hidden"
                        onclick="downloadCardImage()">
                    åˆ—å°/ä¸‹è¼‰å¡ç‰‡
                </button>
            </div>
        </div>
        <p id="statusText" class="text-sm mt-3 text-gray-500 text-center"></p>

        <!-- è‡ªè¨‚ä½³å¥ç®¡ç†å€å¡Š -->
        <div class="bg-white rounded-3xl p-6 md:p-10 shadow-2xl mt-6">
            <button onclick="toggleCustomCardsSection()"
                    class="w-full py-2 px-4 rounded-xl text-sm font-medium text-purple-600 bg-purple-50 hover:bg-purple-100 transition-colors flex justify-between items-center">
                <span>ç®¡ç†æˆ‘çš„ä½³å¥ (<span id="customCardCount">0</span> å¼µ)</span>
                <span id="toggleIcon">â–¼</span>
            </button>
            
            <div id="customCardsSection" class="collapsible">
                <div class="p-4 bg-gray-50 rounded-xl mt-3">
                    <h3 class="font-semibold text-gray-700 mb-2">æ–°å¢ä¸€å‰‡ä½³å¥ï¼š</h3>
                    <textarea id="newCustomQuote" class="w-full p-2 border rounded-lg focus:ring-purple-500 focus:border-purple-500 text-gray-800" rows="3" placeholder="è¼¸å…¥æ‚¨çš„æ¿€å‹µå¥å­ï¼ˆä¾‹å¦‚ï¼šæ•™è‚²æ˜¯ä¸€å ´é¦¬æ‹‰æ¾ï¼Œè€Œä¸æ˜¯çŸ­è·‘ã€‚ï¼‰"></textarea>
                    <button onclick="handleSaveCustomCard()"
                            class="mt-2 w-full py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium transition-colors">
                        å„²å­˜ä½³å¥ä¸¦åŠ å…¥æŠ½å¡åº«
                    </button>
                    
                    <h3 class="font-semibold text-gray-700 mt-4 mb-2 border-t pt-3">æˆ‘çš„è‡ªè¨‚ä½³å¥åˆ—è¡¨ï¼š</h3>
                    <ul id="customCardsList" class="space-y-2 text-sm max-h-40 overflow-y-auto pr-2">
                        <!-- Custom cards will be listed here -->
                        <li class="text-gray-500 italic">ç›®å‰æ²’æœ‰è‡ªè¨‚ä½³å¥ï¼Œé»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢ï¼</li>
                    </ul>
                </div>
            </div>
        </div>

        <footer class="text-center mt-8 pt-4 border-t border-gray-100">
            <p class="text-xs text-gray-400">æ•¸æ“šå°‡å®‰å…¨å­˜å„²æ–¼æ‚¨çš„å°ˆå±¬ç©ºé–“ï¼Œç¢ºä¿æ¯å¤©çš„æ¿€å‹µä¸é‡è¤‡ã€‚</p>
        </footer>
    </div>

    <!-- Firebase / Gemini è…³æœ¬ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, onSnapshot, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®š Firestore æ—¥èªŒç´šåˆ¥ç‚º Debug
        setLogLevel('Debug');

        // å…¨åŸŸè®Šæ•¸
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let customCards = []; // å„²å­˜è‡ªè¨‚å¡ç‰‡
        
        // å¾ Canvas ç’°å¢ƒå–å¾—è®Šæ•¸
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Gemini API Configuration
        const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const systemPrompt = "ä½ æ˜¯ä¸€ä½å……æ»¿åŒç†å¿ƒä¸”ç¶“é©—è±å¯Œçš„è³‡æ·±æ•™å¸«é¡§å•ã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šæä¾›çš„èªå¥ï¼Œç‚ºä½¿ç”¨è€…ï¼ˆä¸€ä½è€å¸«ï¼‰æä¾›ä¸€å€‹ç°¡æ½”ã€å¯¦ç”¨ä¸”æ­£å‘çš„æ‡‰ç”¨å»ºè­°ã€‚è«‹å°‡é€™å¥è©±èˆ‡æ—¥å¸¸æ•™å­¸å£“åŠ›ã€å­¸ç”ŸæŒ‘æˆ°æˆ–è‡ªæˆ‘ç…§é¡§è¯ç¹«èµ·ä¾†ï¼Œçµ¦äºˆæ”¯æŒå’Œå…·é«”è¡Œå‹•æ–¹å‘ã€‚å›æ‡‰å¿…é ˆé™åˆ¶åœ¨ä¸€å€‹æ®µè½å…§ï¼Œç´„ 80-100 å­—ã€‚";


        // å…§å»ºå¡ç‰‡å…§å®¹ (64 å¼µ)
        const builtInCards = [
            "ä½ ä¸å­¤å–®ï¼Œä½ çš„åŠªåŠ›éƒ½æœ‰è¢«çœ‹åˆ°ã€‚",
            "ä½ çš„å°ˆæ¥­åƒ¹å€¼ç„¡å¯å–ä»£ï¼Œè«‹ç‚ºè‡ªå·±æ„Ÿåˆ°é©•å‚²ã€‚",
            "ä»Šå¤©ï¼Œä½ å·²ç¶“åšå¾—å¤ å¥½äº†ï¼Œçµ¦è‡ªå·±ä¸€å€‹å¾®ç¬‘ã€‚",
            "å…è¨±è‡ªå·±ä¼‘æ¯ï¼Œå……é›»å¾Œçš„ä½ æ›´æœ‰åŠ›é‡ã€‚",
            "ä½ çš„è©±èªï¼Œå¯èƒ½æ”¹è®Šäº†ä¸€å€‹å­©å­çš„ä¸€ç”Ÿï¼Œå½±éŸ¿åŠ›ç„¡é å¼—å±†ã€‚",
            "æ¯å€‹æŒ‘æˆ°ï¼Œéƒ½å°‡æˆç‚ºä½ æ•…äº‹è£¡æœ€ç²¾å½©çš„ä¸€é ã€‚",
            "å°‹æ±‚å”åŠ©æ˜¯åŠ›é‡çš„å±•ç¾ï¼Œä¸æ˜¯è»Ÿå¼±ã€‚",
            "æ”¾ä¸‹å°å°çš„æŒ«æŠ˜ï¼Œæ˜å¤©åˆæ˜¯å¶„æ–°çš„ä¸€å¤©ã€‚",
            "ä½ æ­£åœ¨å‰µé€ çš„æœªä¾†ï¼Œæ¯”ä½ æƒ³åƒçš„æ›´å®å¤§ã€‚",
            "ä¸€é¡†ç¨®å­çš„èŒèŠ½ï¼Œå¾€å¾€éœ€è¦å¾ˆä¹…çš„æ™‚å…‰ã€‚è€å¿ƒç­‰å¾…ã€‚",
            "èˆ‡åŒäº‹åˆ†äº«ä½ çš„å›°å¢ƒï¼Œä½ æœƒç™¼ç¾æœ‰äººæ‡‚ä½ ã€‚",
            "ä½ çš„åŠªåŠ›ï¼Œæ¯å¤©éƒ½åœ¨ç™¼å…‰ï¼Œä¸å¿…è‹›æ±‚å®Œç¾ã€‚",
            "é‚£äº›å¾®å°çš„å–„æ„ï¼Œæœƒåœ¨çœ‹ä¸è¦‹çš„åœ°æ–¹é–‹èŠ±çµæœã€‚",
            "ä½ æ•™æœƒçš„ï¼Œä¸åªæ˜¯çŸ¥è­˜ï¼Œæ›´æ˜¯é¢å°ä¸–ç•Œçš„å‹‡æ°£ã€‚",
            "å³ä½¿åªæœ‰ä¸€å€‹äººè¢«ä½ å•Ÿç™¼ï¼Œä½ çš„å·¥ä½œå°±æ„ç¾©éå‡¡ã€‚",
            "è®“æ„›æµå‹•ï¼Œä½ å°‡æ”¶ç©«è¶…ä¹æƒ³åƒçš„å›å ±ã€‚",
            "å­©å­å€‘çš„ç¬‘å®¹ï¼Œå°±æ˜¯å°ä½ æœ€å¥½çš„è‚¯å®šã€‚",
            "å›°é›£ä¸æ˜¯çµ‚é»ï¼Œè€Œæ˜¯è®“ä½ æˆé•·çš„å¢Šè…³çŸ³ã€‚",
            "å…è¨±æ··äº‚ç™¼ç”Ÿï¼Œå¾ä¸­å°‹æ‰¾æ–°çš„æ•™å­¸å¥‘æ©Ÿã€‚",
            "è½‰è®Šæ˜¯å¿…ç„¶çš„ï¼Œæ“æŠ±è®ŠåŒ–ï¼Œä½ å°‡æ›´éˆæ´»ã€‚",
            "è¨˜å¾—ï¼Œå³ä½¿æ˜¯çŠ¯éŒ¯ï¼Œä¹Ÿæ˜¯å­¸ç¿’çš„ä¸€éƒ¨åˆ†ã€‚",
            "ä¿æŒå¥½å¥‡å¿ƒï¼Œä¸–ç•Œæ°¸é æœ‰æ–°çš„æ±è¥¿ç­‰ä½ å»æ¢ç´¢ã€‚",
            "ä½ æ­£åœ¨ç¶“é©—çš„ï¼Œæ˜¯æˆç‚ºæ›´å¥½è‡ªå·±çš„éç¨‹ã€‚",
            "å°å°çš„é€²æ­¥ï¼Œç´¯ç©èµ·ä¾†å°±æ˜¯å·¨å¤§çš„é£›èºã€‚",
            "ä½ çš„å®¶äººå’Œæœ‹å‹ï¼Œæ˜¯ä½ æœ€å …å¯¦çš„å¾Œç›¾ã€‚",
            "æŠ¬é ­çœ‹çœ‹ï¼Œå¤©ç©ºç‚ºä½ å±•é–‹äº†ç„¡é™çš„å¯èƒ½æ€§ã€‚",
            "è¨˜å¾—æ„›è‡ªå·±ï¼Œå› ç‚ºä½ å€¼å¾—é€™ä»½æº«æŸ”ã€‚",
            "æ·±å‘¼å¸ï¼Œæ”¾æ…¢è…³æ­¥ï¼Œå…¨ä¸–ç•Œéƒ½åœ¨ç­‰ä½ ã€‚",
            "ä½ æ˜¯å­¸ç”Ÿå¿ƒä¸­ï¼Œæœ€ç¨ä¸€ç„¡äºŒçš„é¢¨æ™¯ã€‚",
            "ä½ çš„å­˜åœ¨ï¼Œæœ¬èº«å°±æ˜¯å°æ•™è‚²çš„è²¢ç»ã€‚",
            "è¨˜å¾—ä½ æœ€åˆçš„ç†±æƒ…ï¼Œé‚£æ˜¯ä½ æœ€ç¾éº—çš„å‹³ç« ã€‚",
            "æ•™å¸«ç¯€å¿«æ¨‚ï¼æ¯å¤©éƒ½æ˜¯ä½ çš„ç¯€æ—¥ã€‚",
            "æ„›èˆ‡è€å¿ƒï¼Œæ˜¯æ•™è‚²ä¸­æœ€çè²´çš„è³‡ç”¢ã€‚", 
            "ä»Šå¤©çš„ç–²æ†Šï¼Œæ˜¯æ˜¨æ—¥ä»˜å‡ºçš„è­‰æ˜ã€‚", 
            "ä½ çš„å–„è‰¯èˆ‡æ™ºæ…§ï¼Œæ­£åœ¨æº«æš–è¨±å¤šè§’è½ã€‚", 
            "æ•™æ›¸è‚²äººï¼Œä½ çš„äººç”Ÿå……æ»¿äº†æ„ç¾©èˆ‡å…‰èŠ’ã€‚", 
            "åˆ¥å®³æ€•å˜—è©¦æ–°çš„æ–¹æ³•ï¼Œå¤±æ•—ä¹Ÿæ˜¯ç¶“é©—ã€‚", 
            "çµ¦äºˆè‡ªå·±åŒæ¨£çš„å¯¬å®¹ï¼Œå¦‚åŒä½ çµ¦äºˆå­¸ç”Ÿä¸€æ¨£ã€‚", 
            "ä½ å€¼å¾—è¢«å°Šé‡èˆ‡è¢«æ„›ï¼Œä»Šå¤©å…ˆå¾æ„›è‡ªå·±é–‹å§‹ã€‚", 
            "æ•™è‚²æ˜¯ä¸€åº§æ©‹æ¨‘ï¼Œä½ æ˜¯æœ€æœ‰åŠ›çš„ç¯‰æ©‹è€…ã€‚", 
            "ä¿æŒå½ˆæ€§ï¼ŒæŸ”è»Ÿçš„å¿ƒæ›´èƒ½æ‡‰å°è®Šå±€ã€‚", 
            "æ¯ä¸€æ¬¡çš„å‚¾è½ï¼Œéƒ½æ˜¯å°å­¸ç”Ÿæœ€å¥½çš„ç¦®ç‰©ã€‚", 
            "ä½ çš„ç†±æƒ…ï¼Œæ˜¯ç…§äº®èª²å ‚çš„ç‡ˆå¡”ã€‚", 
            "æ”¾ä¸‹æ¯”è¼ƒï¼Œä½ å·²ç¶“åœ¨è‡ªå·±çš„æ™‚å€è£¡ç››é–‹ã€‚", 
            "å‰å¤§çš„äº‹æƒ…ï¼Œå¾€å¾€å¾å¾®å°çš„èµ·æ­¥é–‹å§‹ã€‚", 
            "æ„Ÿè¬ä½ ï¼Œæˆç‚ºå­©å­å€‘ç”Ÿå‘½ä¸­çš„é‡è¦è§’è‰²ã€‚", 
            "ä»Šå¤©åªåšæœ€é‡è¦çš„ä¸‰ä»¶äº‹ï¼Œå…¶é¤˜çš„å¯ä»¥ç­‰å¾…ã€‚", 
            "åˆ¥å¿˜äº†ï¼Œä½ ä¹Ÿæ˜¯éœ€è¦è¢«æ»‹é¤Šçš„åœ’ä¸ã€‚", 
            "ä½ æ’­ä¸‹çš„ç¨®å­ï¼Œç¸½æœ‰ä¸€å¤©æœƒç¶»æ”¾å‡ºç¾éº—çš„èŠ±æœµã€‚", 
            "å…è¨±è‡ªå·±ä¸å®Œç¾ï¼ŒçœŸæ­£çš„æˆé•·ä¾†è‡ªæ–¼æ¥ç´ã€‚", 
            "å‹‡æ•¢åœ°ç‚ºè‡ªå·±è¨­å®šç•Œç·šï¼Œä¿è­·ä½ çš„èƒ½é‡ã€‚", 
            "æ•™å­¸ç›¸é•·ï¼Œä½ å¾å­¸ç”Ÿèº«ä¸Šå­¸åˆ°çš„åŒæ¨£çè²´ã€‚", 
            "ä¼‘æ¯ä¸æ˜¯æµªè²»æ™‚é–“ï¼Œæ˜¯ç‚ºäº†èµ°æ›´é•·é çš„è·¯ã€‚", 
            "ä½ çš„å‰µæ„å’ŒåŠªåŠ›ï¼Œè®“å­¸ç¿’è®Šå¾—æœ‰è¶£ã€‚", 
            "åˆ¥è®“æ˜¨å¤©çš„é™°å½±ï¼Œé®è”½äº†ä»Šå¤©çš„é™½å…‰ã€‚", 
            "æ¯å€‹å­©å­éƒ½æœ‰ç¨ç‰¹çš„åƒ¹å€¼ï¼Œä½ çœ‹åˆ°äº†ä»–å€‘çš„æ½›èƒ½ã€‚", 
            "ä½ æ˜¯æ”¹è®Šä¸–ç•Œçš„æ½›åœ¨åŠ›é‡ï¼Œå³ä½¿åªæ˜¯åœ¨ä¸€å€‹æ•™å®¤è£¡ã€‚", 
            "æ„Ÿè¬ä½ é¸æ“‡äº†é€™æ¢å……æ»¿æŒ‘æˆ°ä½†å…‰æ¦®çš„è·¯ã€‚", 
            "æ·±ä¿¡ä½ çš„åƒ¹å€¼ï¼Œå³ä½¿çµæœä¸ç›¡å¦‚äººæ„ã€‚", 
            "ä»Šå¤©å°±è®“ç…©æƒ±éš¨é¢¨è€Œå»ï¼Œæ˜å¤©å†é‡æ–°æ’¿èµ·ã€‚", 
            "è®“è‡ªå·±æˆç‚ºå¿«æ¨‚çš„ä¾†æºï¼Œé€™æœƒæ„ŸæŸ“èº«é‚Šæ‰€æœ‰äººã€‚", 
            "æ•™å­¸çš„è—è¡“ï¼Œåœ¨æ–¼å¹³è¡¡çŸ¥è­˜èˆ‡å¿ƒéˆçš„æˆé•·ã€‚", 
            "ä½ å°æ•™è‚²çš„æŠ•å…¥ï¼Œå€¼å¾—æ‰€æœ‰äººçš„æ•¬æ„ã€‚", 
            "äº«å—ç•¶ä¸‹ï¼Œæ¯ä¸€å€‹ç‰‡åˆ»éƒ½æ˜¯ç¨ä¸€ç„¡äºŒçš„å¥‡è¹Ÿã€‚"
        ];

        // å½©è™¹å¡ç‰‡é¡è‰² (æŸ”å’Œæ¼¸è®Š)
        const rainbowColors = [
            ['#FFB6C1', '#FFDAB9'], // è¼•ç²‰/èœœæ¡ƒ
            ['#FFA07A', '#FFDEAD'], // æ·ºæ©™/å¥¶æ²¹
            ['#ADD8E6', '#87CEFA'], // æ·ºè—/å¤©ç©º
            ['#98FB98', '#ADFF2F'], // æ·ºç¶ /é»ƒç¶ 
            ['#BA55D3', '#DA70D6'], // ä¸­ç´«/è˜­ç´«
            ['#F08080', '#FA8072'], // çŠç‘š/é®­é­š
            ['#DAA520', '#BDB76B'], // é‡‘é»ƒ/æ©„æ¬–
        ];

        // å–å¾—ä»Šå¤©çš„æ—¥æœŸ (YYYY-MM-DD)
        const getTodayDate = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        document.getElementById('dateDisplay').textContent = `ä»Šå¤©æ˜¯ ${getTodayDate()}`;
        document.getElementById('cardTitle').textContent = "ç³»çµ±æº–å‚™ä¸­...";

        // åˆå§‹åŒ– Firebase
        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // ç¢ºä¿ç™»å…¥ä¸¦ç­‰å¾…èªè­‰ç‹€æ…‹ç©©å®š
                await new Promise(async (resolve) => {
                    // å…ˆå˜—è©¦ç™»å…¥
                    try {
                         if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("ç™»å…¥å˜—è©¦å¤±æ•—:", e);
                    }
                    
                    // è¨»å†Šèªè­‰ç‹€æ…‹è®Šæ›´ç›£è½å™¨ï¼ŒåªåŸ·è¡Œä¸€æ¬¡
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Firebase èªè­‰å®Œæˆï¼ŒUserID:", userId);
                        } else {
                            userId = auth.currentUser?.uid || crypto.randomUUID(); 
                            console.warn("æœªåµæ¸¬åˆ°æœ‰æ•ˆ Auth Tokenï¼Œä½¿ç”¨åŒ¿åæˆ–éš¨æ©Ÿ IDã€‚");
                        }
                        isAuthReady = true;
                        unsubscribe(); 
                        resolve();
                    });
                });
                
                // åªæœ‰åœ¨ isAuthReady ä¸” userId ç¢ºå®šå¾Œæ‰åŸ·è¡Œ Firestore æ“ä½œ
                if (isAuthReady) {
                    checkTodayCard();
                    setupCustomCardsListener(); // è¨­å®šè‡ªè¨‚å¡ç‰‡å³æ™‚ç›£è½
                }

            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
                showMessage("ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œç„¡æ³•ä¿å­˜å¡ç‰‡ç´€éŒ„ã€‚", 'error');
                isAuthReady = true; 
            }
        };

        // é¡¯ç¤ºè¨Šæ¯æ¡†
        const showMessage = (text, type = 'info') => {
            const box = document.getElementById('messageBox');
            box.textContent = text;
            box.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700', 'bg-red-500', 'text-white');
            
            if (type === 'error') {
                box.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                box.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'warning') {
                box.classList.add('bg-red-500', 'text-white'); // å¸å¼•æ³¨æ„çš„è­¦å‘Š
            } else {
                box.classList.add('bg-blue-100', 'text-blue-700');
            }
            // è¨Šæ¯é¡¯ç¤ºå¾Œè‡ªå‹•éš±è—
            setTimeout(() => {
                box.classList.add('hidden');
            }, 5000);
            box.classList.remove('hidden');
        };

        // æ›´æ–°å¡ç‰‡è¦–è¦ºæ•ˆæœ
        const updateCardVisuals = (colorIndex) => {
            const cardElement = document.getElementById('cardContainer');
            // éš¨æ©Ÿé¸æ“‡é¡è‰²ï¼Œè®“æ¯æ¬¡æŠ½å–éƒ½æœ‰æ–°æ„Ÿè¦º
            const randomColorIndex = colorIndex % rainbowColors.length; 
            const [color1, color2] = rainbowColors[randomColorIndex];
            
            cardElement.style.backgroundImage = `linear-gradient(135deg, ${color1} 0%, ${color2} 100%)`;
            cardElement.classList.add('scale-105');
            setTimeout(() => cardElement.classList.remove('scale-105'), 300);
        };

        // æª¢æŸ¥ä»Šå¤©æ˜¯å¦å·²æŠ½å¡
        const checkTodayCard = async () => {
            if (!isAuthReady || !userId) return;

            const today = getTodayDate();
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/teacher_cards`, 'today');
            const drawButton = document.getElementById('drawButton');
            const printButton = document.getElementById('printButton');
            const interpretButton = document.getElementById('interpretButton');
            
            try {
                const docSnap = await getDoc(docRef);
                const isFirstDraw = !docSnap.exists() || docSnap.data().drawnDate !== today;
                
                if (!isFirstDraw) {
                    // ä»Šå¤©å·²æŠ½å¡
                    const data = docSnap.data();
                    const cardMessage = data.cardMessage || "ä»Šæ—¥å¡ç‰‡å…§å®¹éºå¤±ã€‚";
                    const cardIndex = data.cardIndex || 0;
                    displayDrawnCard(cardMessage, cardIndex);
                    
                    drawButton.disabled = false;
                    drawButton.textContent = "é‡æ–°æŠ½å– (ä»Šæ—¥å·²æŠ½)";
                    printButton.classList.remove('hidden'); // é¡¯ç¤ºåˆ—å°æŒ‰éˆ•
                    interpretButton.classList.remove('hidden'); // é¡¯ç¤ºè§£è®€æŒ‰éˆ•
                    document.getElementById('statusText').textContent = "ä¸å–œæ­¡å—ï¼Ÿæ‚¨å¯ä»¥é‡æ–°æŠ½å–ä¸€å¼µï¼Œä½†ä»Šæ—¥ç´€éŒ„æœƒè¢«è¦†è“‹ã€‚";
                    showMessage("æ­¡è¿å›ä¾†ï¼é€™æ˜¯æ‚¨ä»Šå¤©çš„å¡ç‰‡ã€‚", 'info');
                    return;
                }
                
                // ä»Šå¤©å°šæœªæŠ½å¡æˆ–æ•¸æ“šå·²éæœŸ
                drawButton.disabled = false;
                drawButton.textContent = "æŠ½å–ä»Šæ—¥å½©è™¹å¡";
                printButton.classList.add('hidden'); // éš±è—åˆ—å°æŒ‰éˆ•
                interpretButton.classList.add('hidden'); // éš±è—è§£è®€æŒ‰éˆ•
                document.getElementById('cardTitle').textContent = "é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼ŒæŠ½å–ä½ çš„æ¯æ—¥æ¿€å‹µ";
                document.getElementById('cardContent').classList.remove('show-content');
                document.getElementById('cardFooter').classList.remove('show-content');

                showMessage("æº–å‚™å¥½äº†å—ï¼Ÿé»æ“ŠæŒ‰éˆ•æŠ½å–ä»Šæ—¥æ¿€å‹µã€‚", 'info');

            } catch (error) {
                console.error("æª¢æŸ¥ä»Šæ—¥å¡ç‰‡ç´€éŒ„å¤±æ•—:", error);
                showMessage("æª¢æŸ¥ç´€éŒ„å¤±æ•—ï¼Œè«‹é‡æ–°å˜—è©¦æŠ½å–ã€‚", 'error');
                drawButton.disabled = false;
                drawButton.textContent = "æŠ½å–ä»Šæ—¥å½©è™¹å¡";
                printButton.classList.add('hidden');
                interpretButton.classList.add('hidden');
            }
        };

        // é¡¯ç¤ºå·²æŠ½å–å¡ç‰‡
        const displayDrawnCard = (message, index) => {
            const titleElement = document.getElementById('cardTitle');
            const contentElement = document.getElementById('cardContent');
            const footerElement = document.getElementById('cardFooter');
            const printButton = document.getElementById('printButton');
            const interpretButton = document.getElementById('interpretButton');
            const interpretationArea = document.getElementById('geminiInterpretationArea');
            const interpretationText = document.getElementById('geminiInterpretationText');


            // é‡ç½®å‹•ç•«
            contentElement.classList.remove('show-content');
            footerElement.classList.remove('show-content');
            void contentElement.offsetWidth; 
            void footerElement.offsetWidth; 

            // åˆ¤æ–·æ˜¯å¦ç‚ºè‡ªè¨‚å¡ç‰‡
            const isCustom = index >= builtInCards.length;
            titleElement.textContent = isCustom ? "ä»Šæ—¥è‡ªè¨‚ä½³å¥ï¼š" : "ä»Šæ—¥å¡ç‰‡ï¼š";
            contentElement.textContent = message;
            
            contentElement.classList.add('show-content');
            footerElement.classList.add('show-content');
            
            updateCardVisuals(index);
            printButton.classList.remove('hidden'); // ç¢ºä¿é¡¯ç¤ºåˆ—å°æŒ‰éˆ•
            interpretButton.classList.remove('hidden'); // é¡¯ç¤ºè§£è®€æŒ‰éˆ•

            // æ¸…é™¤ä¹‹å‰çš„ AI è§£è®€çµæœ
            interpretationArea.classList.add('hidden');
            interpretationText.textContent = '';
        };

        // æŠ½å¡ä¸»é‚è¼¯
        window.drawCard = async () => {
            if (!isAuthReady) {
                showMessage("ç³»çµ±æº–å‚™ä¸­ï¼Œè«‹ç¨å€™...", 'info');
                return;
            }

            const today = getTodayDate();
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/teacher_cards`, 'today');
            const drawButton = document.getElementById('drawButton');

            // ç¢ºä¿æŒ‰éˆ•è¢«ç¦ç”¨ï¼Œé¿å…é‡è¤‡é»æ“Š
            drawButton.disabled = true;
            drawButton.textContent = "æŠ½å–ä¸­...";

            try {
                // 1. åˆä½µå¡ç‰‡åº« (å…§å»º + è‡ªè¨‚)
                const combinedCardPool = [...builtInCards, ...customCards.map(c => c.quote)];
                
                if (combinedCardPool.length === 0) {
                    showMessage("å¡ç‰‡åº«ç‚ºç©ºï¼è«‹å…ˆæ–°å¢è‡ªè¨‚ä½³å¥æˆ–ç­‰å¾…å…§å»ºå¡ç‰‡è¼‰å…¥ã€‚", 'warning');
                    drawButton.disabled = false;
                    drawButton.textContent = "é‡æ–°æŠ½å– (ä»Šæ—¥å·²æŠ½)";
                    return;
                }

                // 2. å–å¾—æ‰€æœ‰å·²æŠ½å–çš„æ­·å²å¡ç‰‡ï¼Œä»¥ç¢ºä¿æ–°å¡ç‰‡ä¸é‡è¤‡
                const historyDocRef = doc(db, `artifacts/${appId}/users/${userId}/teacher_cards`, 'history');
                const historySnap = await getDoc(historyDocRef);
                const historyData = historySnap.exists() ? historySnap.data() : { drawnIndices: [] };
                
                let drawnIndices = Array.isArray(historyData.drawnIndices) ? historyData.drawnIndices : [];
                
                // å¦‚æœæ‰€æœ‰å¡ç‰‡éƒ½æŠ½å®Œï¼Œå‰‡é‡ç½®æ­·å²ç´€éŒ„
                if (drawnIndices.length >= combinedCardPool.length) {
                    drawnIndices = [];
                    console.log("æ‰€æœ‰å¡ç‰‡å·²æŠ½å–å®Œç•¢ï¼Œæ­·å²ç´€éŒ„å·²é‡ç½®ã€‚");
                }

                // 3. éš¨æ©Ÿé¸å–ä¸€å¼µæœªæŠ½éçš„å¡ç‰‡
                let availableIndices = combinedCardPool.map((_, i) => i).filter(i => !drawnIndices.includes(i));
                if (availableIndices.length === 0) {
                    availableIndices = combinedCardPool.map((_, i) => i);
                }
                
                const randomIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
                const drawnCardMessage = combinedCardPool[randomIndex];

                // 4. æ›´æ–°å¡ç‰‡è¦–è¦ºèˆ‡å…§å®¹
                displayDrawnCard(drawnCardMessage, randomIndex);

                // 5. å°‡æŠ½å–çµæœå­˜å…¥ Firestore
                await setDoc(docRef, {
                    cardMessage: drawnCardMessage,
                    cardIndex: randomIndex,
                    drawnDate: today,
                    timestamp: new Date().getTime()
                });
                
                // 6. æ›´æ–°æ­·å²ç´€éŒ„ï¼ˆåƒ…åœ¨ç•¶å¤©ç¬¬ä¸€æ¬¡æŠ½å¡æ™‚æ›´æ–°æ­·å²ç´€éŒ„ï¼‰
                if (document.getElementById('drawButton').textContent === "æŠ½å–ä»Šæ—¥å½©è™¹å¡") {
                    const newDrawnIndices = [...drawnIndices, randomIndex];
                    await setDoc(historyDocRef, { drawnIndices: newDrawnIndices }, { merge: true });
                }

                drawButton.disabled = false;
                drawButton.textContent = "é‡æ–°æŠ½å– (ä»Šæ—¥å·²æŠ½)";
                document.getElementById('statusText').textContent = "åŠ›é‡å·²æ³¨å…¥ï¼æ‚¨å¯ä»¥é‡æ–°æŠ½å–ï¼Œæˆ–å°‡é€™ä»½èƒ½é‡å¸¶å…¥ä»Šå¤©çš„æ•™å­¸ä¸­ã€‚";
                showMessage("æŠ½å–æˆåŠŸï¼é€™ä»½æ¿€å‹µå°‡ä¼´éš¨ä½ ä¸€æ•´å¤©ã€‚", 'success');

            } catch (error) {
                console.error("æŠ½å–å¡ç‰‡ä¸¦å„²å­˜ç´€éŒ„å¤±æ•—:", error);
                showMessage("æŠ½å–ç´€éŒ„å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œé‡è©¦ã€‚", 'error');
                drawButton.disabled = false; 
                drawButton.textContent = "é‡æ–°æŠ½å– (ä»Šæ—¥å·²æŠ½)"; // å³ä½¿å¤±æ•—ä¹Ÿä¿æŒæŒ‰éˆ•é¡¯ç¤ºå·²æŠ½
            }
        };

        // --- Gemini API æ¿€å‹µèªå¥è§£è®€åŠŸèƒ½ ---
        window.getGeminiInterpretation = async () => {
            const interpretationArea = document.getElementById('geminiInterpretationArea');
            const interpretationText = document.getElementById('geminiInterpretationText');
            const interpretButton = document.getElementById('interpretButton');
            const drawnCardContent = document.getElementById('cardContent').textContent;
            
            if (!drawnCardContent || drawnCardContent === 'å¡ç‰‡å…§å®¹' || drawnCardContent === 'ç³»çµ±æº–å‚™ä¸­...') {
                showMessage('è«‹å…ˆæŠ½å–ä»Šæ—¥å¡ç‰‡ï¼', 'warning');
                return;
            }

            interpretationArea.classList.remove('hidden');
            interpretationText.innerHTML = '<div class="text-center animate-pulse">æ­£åœ¨å‘¼å« Gemini AI æ™ºæ…§è§£è®€ä¸­... è«‹ç¨å€™ âœ¨</div>';
            interpretButton.disabled = true;

            const userQuery = `è«‹æ ¹æ“šé€™å¥æ•™å¸«æ¿€å‹µèªå¥ï¼šã€Œ${drawnCardContent}ã€ï¼Œæä¾›æ‡‰ç”¨å»ºè­°ã€‚`;
            
            // API Call Setup (using exponential backoff)
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let response;
            let success = false;
            let retries = 0;
            const maxRetries = 5;

            while (retries < maxRetries && !success) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        success = true;
                        break;
                    } else if (response.status === 429) {
                        // Rate limit, apply exponential backoff
                        const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                        console.warn(`Rate limit hit, retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        retries++;
                    } else {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                } catch (error) {
                    console.error('Fetch error during retry:', error);
                    retries++;
                    if (retries >= maxRetries) throw error; 
                    // Optional: apply delay before final retry attempt
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            interpretButton.disabled = false;

            if (success) {
                try {
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        interpretationText.innerHTML = text.replace(/\n/g, '<br>');
                        interpretButton.classList.add('hidden'); // è§£è®€æˆåŠŸå¾Œéš±è—æŒ‰éˆ•
                        showMessage('AI è§£è®€å·²å®Œæˆï¼', 'success');
                    } else {
                        interpretationText.textContent = 'AI è§£è®€å¤±æ•—ï¼šç„¡æ³•å–å¾—æœ‰æ•ˆçš„æ–‡å­—å›æ‡‰ã€‚';
                        interpretButton.classList.remove('hidden');
                    }
                } catch (e) {
                    console.error('Parsing or processing error:', e);
                    interpretationText.textContent = 'AI è§£è®€å¤±æ•—ï¼šè§£æå›æ‡‰æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚';
                    interpretButton.classList.remove('hidden');
                }
            } else {
                interpretationText.textContent = 'AI è§£è®€è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œé‡è©¦ã€‚';
                interpretButton.classList.remove('hidden');
            }
        };


        // --- åˆ—å°/ä¸‹è¼‰åŠŸèƒ½ ---
        window.downloadCardImage = async () => {
            const printArea = document.getElementById('printableArea');
            const drawButton = document.getElementById('drawButton');
            const printButton = document.getElementById('printButton');
            const interpretButton = document.getElementById('interpretButton');
            const interpretationArea = document.getElementById('geminiInterpretationArea');
            const interpretationText = document.getElementById('geminiInterpretationText'); // <--- ä¿®æ­£ï¼šæ–°å¢å®šç¾©

            // æš«æ™‚éš±è—æŒ‰éˆ•ï¼Œç¢ºä¿æˆªåœ–ä¹¾æ·¨
            drawButton.classList.add('hidden');
            printButton.classList.add('hidden');
            interpretButton.classList.add('hidden'); // éš±è— AI æŒ‰éˆ•

            // æª¢æŸ¥ AI è§£è®€å€æ˜¯å¦å·²å±•é–‹ï¼Œè‹¥æœªå±•é–‹å‰‡æš«æ™‚æ”¶åˆ
            const wasInterpretationAreaHidden = interpretationArea.classList.contains('hidden');
            if (wasInterpretationAreaHidden) {
                interpretationArea.classList.remove('hidden');
            }
            
            // å»¶é²åŸ·è¡Œï¼Œç¢ºä¿ DOM ç‹€æ…‹æ›´æ–°å®Œæˆ
            setTimeout(async () => {
                try {
                    const canvas = await html2canvas(printArea, {
                        backgroundColor: '#f7f3f9', // æ•æ‰å€åŸŸçš„èƒŒæ™¯è‰²
                        scale: 2, // ä½¿ç”¨è¼ƒé«˜è§£æåº¦æˆªåœ–
                    });

                    const today = getTodayDate();
                    const fileName = `æƒ…ç·’å½©è™¹å¡_${today}.png`;
                    
                    // å‰µå»ºè‡¨æ™‚ä¸‹è¼‰é€£çµ
                    const image = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.href = image;
                    link.download = fileName;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    showMessage("å¡ç‰‡åœ–ç‰‡å·²æˆåŠŸä¸‹è¼‰ï¼", 'success');
                } catch (error) {
                    console.error("ä¸‹è¼‰å¡ç‰‡åœ–ç‰‡å¤±æ•—:", error);
                    showMessage("ä¸‹è¼‰å¡ç‰‡åœ–ç‰‡å¤±æ•—ã€‚", 'error');
                } finally {
                    // æ¢å¾©æŒ‰éˆ•å¯è¦‹æ€§
                    drawButton.classList.remove('hidden');
                    printButton.classList.remove('hidden');
                    // åªæœ‰åœ¨ AI è§£è®€æŒ‰éˆ•æœªè¢«é»æ“Šæ™‚ï¼Œæ‰æ¢å¾©å®ƒçš„å¯è¦‹æ€§
                    if (interpretationText.textContent === '') {
                        interpretButton.classList.remove('hidden');
                    }
                    // æ¢å¾© AI è§£è®€å€å¡Šçš„éš±è—ç‹€æ…‹ (å¦‚æœåŸæœ¬æ˜¯éš±è—çš„)
                    if (wasInterpretationAreaHidden) {
                        interpretationArea.classList.add('hidden');
                    }
                }
            }, 100); 
        };
        // --- è‡ªè¨‚ä½³å¥åŠŸèƒ½ (CRUD) ---

        // è¨­å®šè‡ªè¨‚å¡ç‰‡çš„å³æ™‚ç›£è½
        const setupCustomCardsListener = () => {
            if (!isAuthReady || !userId) return;

            const customCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/custom_cards`);
            
            // ä½¿ç”¨ onSnapshot ç›£è½è‡ªè¨‚å¡ç‰‡è®Šæ›´
            onSnapshot(query(customCollectionRef), (snapshot) => {
                const fetchedCards = [];
                snapshot.forEach(doc => {
                    fetchedCards.push({ id: doc.id, ...doc.data() });
                });
                customCards = fetchedCards; // æ›´æ–°å…¨åŸŸè®Šæ•¸
                renderCustomCardsList();
            }, (error) => {
                console.error("ç›£è½è‡ªè¨‚ä½³å¥å¤±æ•—:", error);
                showMessage("è¼‰å…¥è‡ªè¨‚ä½³å¥å¤±æ•—ã€‚", 'error');
            });
        };

        // æ¸²æŸ“è‡ªè¨‚ä½³å¥åˆ—è¡¨
        const renderCustomCardsList = () => {
            const listElement = document.getElementById('customCardsList');
            const countElement = document.getElementById('customCardCount');
            listElement.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨
            
            countElement.textContent = customCards.length;

            if (customCards.length === 0) {
                listElement.innerHTML = '<li class="text-gray-500 italic">ç›®å‰æ²’æœ‰è‡ªè¨‚ä½³å¥ï¼Œé»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢ï¼</li>';
                return;
            }

            customCards.forEach(card => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 bg-white rounded-lg border';
                li.innerHTML = `
                    <span class="flex-1 mr-4 text-gray-700">${card.quote}</span>
                    <button data-id="${card.id}" 
                            onclick="handleDeleteCustomCard(this.dataset.id)"
                            class="text-red-500 hover:text-red-700 p-1 rounded-full transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                `;
                listElement.appendChild(li);
            });
        };

        // å„²å­˜æ–°çš„è‡ªè¨‚ä½³å¥
        window.handleSaveCustomCard = async () => {
            if (!isAuthReady || !userId) {
                showMessage("ç³»çµ±å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å€™å†è©¦ã€‚", 'error');
                return;
            }

            const input = document.getElementById('newCustomQuote');
            const quote = input.value.trim();

            if (quote.length < 5) {
                showMessage("ä½³å¥å…§å®¹å¤ªçŸ­äº†ï¼Œè«‹è‡³å°‘è¼¸å…¥ 5 å€‹å­—ã€‚", 'warning');
                return;
            }

            try {
                const customCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/custom_cards`);
                await addDoc(customCollectionRef, {
                    quote: quote,
                    createdAt: new Date().getTime()
                });
                input.value = '';
                showMessage("è‡ªè¨‚ä½³å¥å„²å­˜æˆåŠŸï¼å·²åŠ å…¥æŠ½å¡åº«ã€‚", 'success');
            } catch (error) {
                console.error("å„²å­˜è‡ªè¨‚ä½³å¥å¤±æ•—:", error);
                showMessage("å„²å­˜è‡ªè¨‚ä½³å¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚", 'error');
            }
        };

        // åˆªé™¤è‡ªè¨‚ä½³å¥
        window.handleDeleteCustomCard = async (docId) => {
            if (!isAuthReady || !userId) return;

            // ç‚ºäº†ä¸ä½¿ç”¨ alert/confirmï¼Œæˆ‘å€‘ç›´æ¥åŸ·è¡Œåˆªé™¤ä¸¦çµ¦äºˆæç¤º
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/custom_cards`, docId);
                await deleteDoc(docRef);
                showMessage("ä½³å¥å·²ç§»é™¤ã€‚", 'info');
            } catch (error) {
                console.error("åˆªé™¤è‡ªè¨‚ä½³å¥å¤±æ•—:", error);
                showMessage("åˆªé™¤è‡ªè¨‚ä½³å¥å¤±æ•—ã€‚", 'error');
            }
        };

        // å±•é–‹/æ”¶åˆè‡ªè¨‚ä½³å¥å€å¡Š
        window.toggleCustomCardsSection = () => {
            const section = document.getElementById('customCardsSection');
            const icon = document.getElementById('toggleIcon');
            section.classList.toggle('active');
            if (section.classList.contains('active')) {
                icon.textContent = 'â–²';
            } else {
                icon.textContent = 'â–¼';
            }
        };

        // è¦–çª—è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ– Firebase
        window.onload = initFirebase;
    </script>
</body>
</html>